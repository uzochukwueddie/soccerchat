<% layout('layout') %>


<div class="chat">

  <div class="chat__sidebar">
    <div class="user-name">
        <span class="user-menu_profile-pic"></span>
        <span class="user-menu_username">
            <a href="/settings/profile" style="color:#fff; text-decoration:none;font-weight:normal; font-size:16px;">@<%= user.username %></a>
        </span>
        <img class="connection_icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAABmFBMVEUAAAD////////////////////////////////////2+/LR5bKw1Hmfy1KUxz2VyD2izVKz1nnS5rP////A3JuOw0qKwkCNxD+QxT6Sxj6Txz6SxUnC3Jv1+fGXx2GDvkCGwECIwUCLwj+PxD6PxT+JwUCFwECZyGD2+vGSxWF9vEGAvkGDv0CMwz+Wx2GPw2F4ukJ7u0J+vUGBvkGHwUB8u0KSxGG31pp0uEN3uUJ5u0KFv0CCv0B6u0K415p5uU1yt0N/vUF1uEN8u0zG3bFttURwtkR5ukLH3rGWxnlqtERutUR2uUOZx3l6uVZos0VvtkRxt0Nzt0N8ulVisUVlskVns0VzuENmskVfsEVps0VztlZer0VhsEVjsUVstER1t1aOwXhcrkZdr0VgsEaQwnm/2a9YrUZbrka/2rDz+PFhr09XrEZksE6pzplUq0ZVrEZarUaqzpl0tWJRq0dWrEZ1tmJztWJOqUdSq0dxtGJMqEdNqUdQqkdytWKmzJhXrFBKqEdZrU+716+GvXhjr1dIp0hkr1dYtVOVAAAAFHRSTlMAV8/v/wCH+x/n////////////9kvBHZAAAAG7SURBVHgBvdOxjtNAEIDhGe/MZO3sxVaiIJkiSNdQUPJOeQlqXoCCIg/EU9BQHRKg5CT7ErzrHTa+aBOqaxC/tdLK+2kbj+H/hoWhlCmQr0HeyYxyM8mvkWHKoAfBS6cBWEeYugAzf4QGp1SV8DvU/ZjBdN7iud6hdnOTdl+TuALyrUPEwfdu3nc1ipr9AwdIFZPysJylRDfa6cZL2rfgMd9QjO8R0Y+/u7sa4LHZz4wN/MXEyw1hbK1VZdV7PZ1OyufzktsxXADCW5EkXq06Paan02Uoo3kHmAEzJ8HBN6v5qlkqaxTmCdAzQK8Noi6rXwCrJyutepUMAARnXS++3cvm2xvftR0PzAyQAXtwdNChifvFHppBdR003IDCIg6JDOse4DX8WIdo1TwfpaUgqWC9c4eqqg5HF20QZdAMmDlasdHWkrKR03J0A4iIXRTrpba29laiY8YMyOyMKYkXroyROZZuwVTyztAFJPmZKBGq+FxFVBr5BHr7ubd3GICfAM+88qDHHYe/BmbbIAaGKU/Fz10emDxyHxBhgJTg+DGP3O3QbltMBkd92F2H9sWxB772wo9z2z8FfwDHWbdKLDfq1AAAAABJRU5ErkJggg==">
        <span class="connection_status">online</span>
    </div><br><br><br><br>
    <h3 class="user-menu_username">
        <a href="/home" style="color:#4aa1f3; text-decoration:none; font-size:16px; font-weight:normal">Soccer Chat</a> | 
        <a href="/group/<%= user.club %>" style="color:#26282A; text-decoration:none;font-weight:normal; font-size:16px;"><%= user.club %></a>
    </h3>
    
    <div class="listings">
        <div class="listings_channels">
            <h2 class="listings_header">Favourite Clubs (<%= data.favClub.length %>)</h2>
            <ul class="channel_list">
                <div>
                    <% if(data.favClub.length > 0) {%>
                        <% data.favClub.forEach(function(val){ %>
                              <li class="channel channel_lists">
                                   <a href="/group/<%= val.favClubName %>" class="user-menu_username channel_name">
                                      <i class="fa fa-futbol-o" aria-hidden="true"></i>
                                       <%= val.favClubName %>
                                   </a>
                              </li>
                        <% }) %>
                    <% } else {%>
                        <li class="channel channel_lists">
                            <a href="#" class="user-menu_username channel_name">
                                No Favourite Clubs
                            </a>
                        </li>
                    <% } %>
                </div>
            </ul>
        </div>
      </div>
      
      <div class="listings">
          <div class="listings_channels">
            <h2 class="listings_header">Friends (<%= data.friendsList.length %>)</h2>
            <ul class="channel_list">
                <div>
                    <% if(data.friendsList.length > 0) {%>
                        <% data.friendsList.forEach(function(val){ %>
                         <li class="channel channel_lists">
                          <a class="channel_name " href="/chat/@<%= val.friendName.replace(/ /g, "-") %>@<%= user.username.replace(/ /g, "-") %>">
                            <div class="imgName">
                               <img src="http://placehold.it/27x27" width="27px" height="27px" class="img-responsive img-circle">
                              <h3>@<%= val.friendName %></h3> 
                            </div>
                             
                          </a>
                          </li>
                        <% }) %>
                    <% } else { %>
                        <li class="channel channel_lists">
                            <a href="#" class="user-menu_username channel_name">
                                No Friends Yet
                            </a>
                        </li>
                    <% } %>
                    
                </div>
                
            </ul>
        </div>
      </div>
      
  </div>

  <div class="chat__main">
    <div class="header" style="">

    <div class="channel-menu">
       
        <span class="channel-menu_name">
            <%= name %>
        </span>
        
        <span class="channel-menu_name">
            <ul id="nav" class="navbar">
                <li id="notification_li">
                <% if(data.request.length > 0) {%>
                <span id="notification_count"><%= data.request.length %></span>
                <% } %>
                <a href="#" id="notificationLink"><i class="fa fa-user-plus"></i></a>
                    <div id="notificationContainer">
                        <div id="notificationTitle">
                            Friend Requests
                        </div>
                        <div id="notificationsBody" class="notifications">
                           <% if(data.request.length > 0) {%>
                            <% data.request.forEach(function(val){ %>
                                   <div class="media">
                                    <span class="pull-left">
                                        <img class="media-object img-responsive img-circle" src="http://placehold.it/50x50" >
                                    </span>
                                    <div class="media-body">
                                        <div class="media-heading">
                                            <strong>
                                                <%= val.username %>
                                            </strong>
                                        </div>
                                        
                                        <div class="media-text">
                                            <input type="hidden" name="senderId" id="senderId" value="<%= val.userId %>">
                                           <input type="hidden" name="senderName" id="senderName" value="<%= val.username %>">
                                           <button type="submit" name="accept" id="accept_friend" class="btn btn-primary accept"><i class="fa fa-check"></i> Accept</button>

                                           <input type="hidden" name="user_Id" id="user_Id" value="<%= val.userId %>">

                                           <button type="submit" name="cancel" id="cancel_friend" class="btn remove"><i class="fa fa-remove"></i> Cancel</button>
                                       
                                       </div>
                                        
                                    </div>
                                  </div>
                          <% }) %>
                          <% } else{ %>
                              <h3 class="text-center">No Friend Request</h3>
                        <% } %>
                        </div>
                        <div id="notificationFooter"><a href="#">See All</a></div>
                    </div>
                </li>
            </ul>
        </span>
        
        <span class="channel-menu_name">
            <ul id="nav2" class="navbar">
                <li id="notification2_li">
                <% var numOfTrue = 0 %>
                <% for(var i=0;i<chat.length;i++){
                    if(chat[i].body.isRead === false)
                       numOfTrue = numOfTrue + 1
                }%>
                
                <% if(numOfTrue > 0) {%>
                <span id="notification_count2"><%= numOfTrue %></span>
                <% } %>
                <a href="#" id="notificationLink2"><i class="fa fa-bell"></i></a>
                    <div id="notificationContainer2">
                        <div id="notificationTitle2">
                            Notifications
                        </div>
                        <div id="notificationsBody2" class="notifications">
                        <% if(chat.length > 0) {%>
                           <% chat.forEach(function(val){ %>
                           <% if(user.username !== val.body.receiverName) {%>
                               <form method="POST" id="chatName">
                                <a href="/chat/@<%= val.body.receiverName %>@<%= user.username %>">
                                
                                <div class="media">
                                    <span class="pull-left">
                                        <img class="media-object img-responsive img-circle" src="http://placehold.it/50x50" >
                                    </span>
                                    <div class="media-body">
                                        <div class="media-heading">
                                        <strong>
                                        <% if(user.username !== val.body.receiverName) {%>
                                            <%= val.body.receiverName %>
                                        <% } else { %>
                                            <%= val.body.authorName %>
                                        <% } %>
                                        </strong>
                                       </div>
                                       
                                       <div class="media-text">
                                           <input type="hidden" name="chatId" id="chatId" value="<%= val.body._id %>">
                                           <input type="hidden" name="clubName" id="clubName" value="<%= name %>@<%= user.username %>">
                                           <% if(val.body.isRead == true){ %> 
                                               <p class="textRead"><%= val.body.body %></p>
                                           <% } else { %>
                                               <p class="textNotRead"><%= val.body.body %></p>
                                           <% } %>
                                       </div>

                                    </div>
                                  </div>
                            </a>
                            </form>
                            
                            <% } else {%>
                               <form method="POST" id="chatName">
                                    <a href="/chat/@<%= val.body.authorName %>@<%= user.username %>">

                                    <div class="media">
                                        <span class="pull-left">
                                            <img class="media-object img-responsive img-circle" src="http://placehold.it/50x50" >
                                        </span>
                                        <div class="media-body">
                                            <div class="media-heading">
                                            <strong>
                                            <% if(user.username !== val.body.receiverName) {%>
                                                <%= val.body.receiverName %>
                                            <% } else { %>
                                                <%= val.body.authorName %>
                                            <% } %>
                                            </strong>
                                           </div>
                                           
                                           <div class="media-text">
                                               <input type="hidden" name="chatId" id="chatId" value="<%= val.body._id %>">
                                               <input type="hidden" name="clubName" id="clubName" value="<%= name %>@<%= user.username %>">
                                               <% if(val.body.isRead == true){ %> 
                                                   <p class="textRead"><%= val.body.body %></p>
                                               <% } else { %>
                                                   <p class="textNotRead"><%= val.body.body %></p>
                                               <% } %>
                                           </div>

                                        </div>
                                      </div>
                                    </a>
                                    </form>
                            <% } %>
                                
                              <% }) %>
                          <% } %>
                          
                        </div>
                        <div id="notificationFooter"><a href="#"></a></div>
                    </div>
                </li>
            </ul>
        </span>
        
        
        
<!--
        <form method="GET" class="navbar-form navbar-right navbar_form">
            <div class="form-group">
              <input type="text" name="search" id="search" class="form-control" placeholder="Search">
            </div>
            <button type="submit" id="searchBtn" class="btn btn-default">Submit</button>
        </form>
-->
        
        <span class="logoutBtn">
            <a href="/logout">Logout</a>
        </span>
        
        
        
    </div>
</div>

    <ol id="messages" class="chat__messages">
        <% chats.forEach(function(val){ %>
            <li class="message">
                <a href="" class="message_profile" ></a>
                  <div class="message__title">
                    <h4 class="userFrom"><%= val.authorName %></h4>
                    <span><%= moment(val.createdAt).format('LT') %></span>
                  </div>

                  <div class="message__body">
                    <p class="userText"><%= val.body %></p>
                  </div>
             </li>
        <% }) %>
    </ol>

    <div class="chat__footer">
     
         <form action="" id="message_form">
            <input type="hidden" name="sender" id="sender" class="" value="<%= user.username %>"><br>
            <input type="hidden" name="room_name" id="room_name" class="" value="<%= chatNames %>"><br>
            
            <input type="hidden" name="receiverId" id="receiverId" class="" value="<%= data1._id %>"><br>

            <input type="text" name="message" class="input-box_text" id="message" placeholder="Type your message" autofocus autocomplete="off">
            <button class="btn btn-primary" id="chatMessage">Send</button>
        </form>
    </div>

  </div>
    
    <script id="message-template" type="text/template">
        <li class="message">
            <a href="" class="message_profile" ></a>
              <div class="message__title">
                <h4 class="userFrom">{{from}}</h4>
                <span>{{createdAt}}</span>
              </div>

              <div class="message__body">
                <p class="userText">{{text}}</p>
              </div>
         </li>
    </script>
    
    



<% include ./partials/chat_footer %>
</div>

<script type="text/javascript" >
$(document).ready(function(){
    $("#notificationLink").click(function(){
        $("#notificationContainer").fadeToggle(300);
        $("#notification_count").fadeOut("slow");
        return false;
    });

    //Document Click hiding the popup 
    $('.chat').click(function(){
        $("#notificationContainer").hide();
        $("#notificationContainer2").hide();
    });
    
    $("#notificationLink2").click(function(){
        $("#notificationContainer2").fadeToggle(300);
        $("#notification_count2").fadeOut("slow");
        return false;
    });

    //Document Click hiding the popup 
    $('.fa').click(function(){
        $("#notificationContainer").hide();
        $("#notificationContainer2").hide();
    });
    
    $(document).on('click', '#chatName', function(){
        
        var chatId = $('#chatId').val();
        var clubName = $('#clubName').val();
        
        console.log(name)
        console.log(clubName)
        
//        $('p').removeClass('textNotRead').addClass('textRead')
        
        $.ajax({
            url: '/chat/'+clubName,
            type: 'POST',
            data: {chatId: chatId, clubName:clubName},
            success: function(){
                
            }
        })
    })

});
</script>


